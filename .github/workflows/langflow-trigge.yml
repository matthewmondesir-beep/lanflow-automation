name: Langflow Automation

on:
  schedule:
    - cron: '*/5 * * * *'  # Every 5 minutes (TESTING)
  workflow_dispatch:

jobs:
  trigger-langflow:
    runs-on: ubuntu-latest
    
    steps:
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install requests
      
      - name: Trigger Langflow Workflow
        env:
          LANGFLOW_API_KEY: ${{ secrets.LANGFLOW_API_KEY }}
        run: |
          python << 'EOF'
          import requests
          import json
          import os
          from datetime import datetime
          
          print(f"ðŸš€ Starting Langflow workflow execution at {datetime.now()}")
          
          url = "https://agentstudio.servicesessentials.ibm.com/api/v1/run/f5758db6-035e-4185-ba5b-5d982ac325f8"
          
          api_key = os.environ.get("LANGFLOW_API_KEY", "").strip()
          
          headers = {
              "Content-Type": "application/json",
              "x-api-key": api_key,
              "User-Agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36",
              "Accept": "application/json"
          }
          
          data = {
              "output_type": "chat",
              "input_type": "text",
              "input_value": f"TEST: Automated trigger at {datetime.now()}"
          }
          
          params = {"stream": "false"}
          
          try:
              response = requests.post(
                  url,
                  headers=headers,
                  json=data,
                  params=params,
                  allow_redirects=True,
                  timeout=30
              )
              
              print(f"Status Code: {response.status_code}")
              print(f"Response: {response.text[:500]}")
              
              if 200 <= response.status_code < 400:
                  print("âœ… Workflow executed successfully!")
                  exit(0)
              else:
                  print(f"âŒ Workflow execution failed with status {response.status_code}")
                  exit(1)
                  
          except Exception as e:
              print(f"âŒ Error: {str(e)}")
              exit(1)
          EOF
